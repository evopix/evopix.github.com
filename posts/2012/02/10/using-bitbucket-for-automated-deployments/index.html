<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Using Bitbucket for Automated Deployments - Brandon Summers</title><meta name=Description content><meta property="og:title" content="Using Bitbucket for Automated Deployments"><meta property="og:description" content="There are many different ways to handle deployments, but I have become very fond of using Bitbucket&rsquo;s service hooks. In this case we&rsquo;re going to be using the POST service hook, which is basically a git post-receive hook that sends a POST request to a given url every time you push to your repository.
Note: This is a really simple and effecient way to handle deployments for smaller projects (e.g. Static websites, Wordpress, etc."><meta property="og:type" content="article"><meta property="og:url" content="https://brandonsummers.name/posts/2012/02/10/using-bitbucket-for-automated-deployments/"><meta property="og:image" content="https://brandonsummers.name/images/me.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-02-10T17:01:00-07:00"><meta property="article:modified_time" content="2022-08-25T01:25:16-07:00"><meta property="og:site_name" content="Brandon Summers"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://brandonsummers.name/images/me.png"><meta name=twitter:title content="Using Bitbucket for Automated Deployments"><meta name=twitter:description content="There are many different ways to handle deployments, but I have become very fond of using Bitbucket&rsquo;s service hooks. In this case we&rsquo;re going to be using the POST service hook, which is basically a git post-receive hook that sends a POST request to a given url every time you push to your repository.
Note: This is a really simple and effecient way to handle deployments for smaller projects (e.g. Static websites, Wordpress, etc."><meta name=application-name content="Brandon Summers"><meta name=apple-mobile-web-app-title content="Brandon Summers"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://brandonsummers.name/posts/2012/02/10/using-bitbucket-for-automated-deployments/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Using Bitbucket for Automated Deployments","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/brandonsummers.name\/posts\/2012\/02\/10\/using-bitbucket-for-automated-deployments\/"},"image":[{"@type":"ImageObject","url":"https:\/\/brandonsummers.name\/images\/me.png","width":180,"height":180}],"genre":"posts","keywords":"bitbucket, git, php","wordcount":1191,"url":"https:\/\/brandonsummers.name\/posts\/2012\/02\/10\/using-bitbucket-for-automated-deployments\/","datePublished":"2012-02-10T17:01:00-07:00","dateModified":"2022-08-25T01:25:16-07:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Brandon Summers"},"description":""}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-29125605-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Brandon Summers"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.png data-srcset="/images/logo.png, /images/logo.png 1.5x, /images/logo.png 2x" data-sizes=auto alt=/images/logo.png title=/images/logo.png width=36 height=36>Brandon Summers</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/evopix title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Brandon Summers"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.png data-srcset="/images/logo.png, /images/logo.png 1.5x, /images/logo.png 2x" data-sizes=auto alt=/images/logo.png title=/images/logo.png width=36 height=36>Brandon Summers</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/evopix title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Using Bitbucket for Automated Deployments</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Brandon Summers</a></span>&nbsp;<span class=post-category>included in <a href=/categories/webdev/><i class="far fa-folder fa-fw" aria-hidden=true></i>webdev</a>&nbsp;<a href=/categories/workflow/><i class="far fa-folder fa-fw" aria-hidden=true></i>workflow</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2012-02-10>2012-02-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1191 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#work-flow>Work flow</a></li><li><a href=#setting-up-the-server>Setting up the Server</a></li><li><a href=#creating-the-deployment-script>Creating the Deployment Script</a></li><li><a href=#configuring-the-script>Configuring the Script</a></li><li><a href=#post-deploy>Post Deploy</a></li><li><a href=#setting-up-the-service-hook>Setting Up the Service Hook</a></li><li><a href=#taking-it-a-step-further>Taking it a Step Further</a></li><li><a href=#what-about-github>What About Github?</a></li></ul></nav></div></div><div class=content id=content><p>There are many different ways to handle deployments, but I have become very fond of using Bitbucket&rsquo;s <a href=http://confluence.atlassian.com/display/BITBUCKET/Managing+bitbucket+Services target=_blank rel="noopener noreffer">service hooks</a>. In this case we&rsquo;re going to be using the <a href=http://confluence.atlassian.com/display/BITBUCKET/Setting+Up+the+bitbucket+POST+Service target=_blank rel="noopener noreffer">POST service hook</a>, which is basically a git post-receive hook that sends a POST request to a given url every time you push to your repository.</p><p><em>Note: This is a really simple and effecient way to handle deployments for smaller projects (e.g. Static websites, Wordpress, etc.), but if your project is any bigger than those you should really be using a <a href=http://en.wikipedia.org/wiki/Continuous_integration target=_blank rel="noopener noreffer">CI server</a> to push out deployments.</em></p><h2 id=work-flow>Work flow</h2><ol><li>Commit changes and push them up to your Bitbucket repository</li><li>Bitbucket sends a <code>POST</code> request to a deployment script on your server</li><li>The deployment script pulls changes into it&rsquo;s local repository (which is in the web-root) which updates the website</li><li>Repeat</li></ol><h2 id=setting-up-the-server>Setting up the Server</h2><p>To get started you&rsquo;ll need to create a clone of your projects git repository that&rsquo;s hosted on Bitbucket.</p><p><em>Note: If your repository is private you&rsquo;ll need to <a href=http://confluence.atlassian.com/display/BITBUCKET/Set+up+SSH+for+Git target=_blank rel="noopener noreffer">create a public/private key pair on your server and add it to your Bitbucket account</a>. If you don&rsquo;t do this your server won&rsquo;t be able to connect with Bitbucket.</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>cd</span> /var/www/foobar.com
</span></span><span class=line><span class=cl>git clone git@bitbucket.org:baz/foobar.com.git .
</span></span></code></pre></div><h2 id=creating-the-deployment-script>Creating the Deployment Script</h2><p>Create a php file named <code>deploy.php</code> and add the following code to it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>date_default_timezone_set</span><span class=p>(</span><span class=s1>&#39;America/Los_Angeles&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Deploy</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * A callback function to call after the deploy has finished.
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @var callback
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$post_deploy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * The name of the file that will be used for logging deployments. Set to 
</span></span></span><span class=line><span class=cl><span class=sd>     * FALSE to disable logging.
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @var string
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$_log</span> <span class=o>=</span> <span class=s1>&#39;deployments.log&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * The timestamp format used for logging.
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @link    http://www.php.net/manual/en/function.date.php
</span></span></span><span class=line><span class=cl><span class=sd>     * @var     string
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$_date_format</span> <span class=o>=</span> <span class=s1>&#39;Y-m-d H:i:sP&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * The name of the branch to pull from.
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @var string
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$_branch</span> <span class=o>=</span> <span class=s1>&#39;master&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * The name of the remote to pull from.
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @var string
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$_remote</span> <span class=o>=</span> <span class=s1>&#39;origin&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * The directory where your website and git repository are located, can be 
</span></span></span><span class=line><span class=cl><span class=sd>     * a relative or absolute path
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @var string
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$_directory</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * Sets up defaults.
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @param  string  $directory  Directory where your website is located
</span></span></span><span class=line><span class=cl><span class=sd>     * @param  array   $data       Information about the deployment
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$directory</span><span class=p>,</span> <span class=nv>$options</span> <span class=o>=</span> <span class=k>array</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Determine the directory path
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_directory</span> <span class=o>=</span> <span class=nx>realpath</span><span class=p>(</span><span class=nv>$directory</span><span class=p>)</span><span class=o>.</span><span class=nx>DIRECTORY_SEPARATOR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$available_options</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;log&#39;</span><span class=p>,</span> <span class=s1>&#39;date_format&#39;</span><span class=p>,</span> <span class=s1>&#39;branch&#39;</span><span class=p>,</span> <span class=s1>&#39;remote&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span> <span class=p>(</span><span class=nv>$options</span> <span class=k>as</span> <span class=nv>$option</span> <span class=o>=&gt;</span> <span class=nv>$value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$option</span><span class=p>,</span> <span class=nv>$available_options</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=p>{</span><span class=s1>&#39;_&#39;</span><span class=o>.</span><span class=nv>$option</span><span class=p>}</span> <span class=o>=</span> <span class=nv>$value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>log</span><span class=p>(</span><span class=s1>&#39;Attempting deployment...&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * Writes a message to the log file.
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @param  string  $message  The message to write
</span></span></span><span class=line><span class=cl><span class=sd>     * @param  string  $type     The type of log message (e.g. INFO, DEBUG, ERROR, etc.)
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>log</span><span class=p>(</span><span class=nv>$message</span><span class=p>,</span> <span class=nv>$type</span> <span class=o>=</span> <span class=s1>&#39;INFO&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Set the name of the log file
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$filename</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_log</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span> <span class=o>!</span> <span class=nx>file_exists</span><span class=p>(</span><span class=nv>$filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Create the log file
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>file_put_contents</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// Allow anyone to write to log files
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>chmod</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=mo>0666</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Write the message into the log file
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// Format: time --- type: message
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>file_put_contents</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=nx>date</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_date_format</span><span class=p>)</span><span class=o>.</span><span class=s1>&#39; --- &#39;</span><span class=o>.</span><span class=nv>$type</span><span class=o>.</span><span class=s1>&#39;: &#39;</span><span class=o>.</span><span class=nv>$message</span><span class=o>.</span><span class=nx>PHP_EOL</span><span class=p>,</span> <span class=nx>FILE_APPEND</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>     * Executes the necessary commands to deploy the website.
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Make sure we&#39;re in the right directory
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>exec</span><span class=p>(</span><span class=s1>&#39;cd &#39;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_directory</span><span class=p>,</span> <span class=nv>$output</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>log</span><span class=p>(</span><span class=s1>&#39;Changing working directory... &#39;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=nv>$output</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Discard any changes to tracked files since our last deploy
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>exec</span><span class=p>(</span><span class=s1>&#39;git reset --hard HEAD&#39;</span><span class=p>,</span> <span class=nv>$output</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>log</span><span class=p>(</span><span class=s1>&#39;Reseting repository... &#39;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=nv>$output</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Update the local repository
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>exec</span><span class=p>(</span><span class=s1>&#39;git pull &#39;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_remote</span><span class=o>.</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_branch</span><span class=p>,</span> <span class=nv>$output</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>log</span><span class=p>(</span><span class=s1>&#39;Pulling in changes... &#39;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=nv>$output</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Secure the .git directory
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>exec</span><span class=p>(</span><span class=s1>&#39;chmod -R og-rx .git&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>log</span><span class=p>(</span><span class=s1>&#39;Securing .git directory... &#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>is_callable</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>post_deploy</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>call_user_func</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>post_deploy</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>log</span><span class=p>(</span><span class=s1>&#39;Deployment successful.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>catch</span> <span class=p>(</span><span class=nx>Exception</span> <span class=nv>$e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>log</span><span class=p>(</span><span class=nv>$e</span><span class=p>,</span> <span class=s1>&#39;ERROR&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// This is just an example
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$deploy</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Deploy</span><span class=p>(</span><span class=s1>&#39;/var/www/foobar.com&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$deploy</span><span class=o>-&gt;</span><span class=na>post_deploy</span> <span class=o>=</span> <span class=k>function</span><span class=p>()</span> <span class=k>use</span> <span class=p>(</span><span class=nv>$deploy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// hit the wp-admin page to update any db changes
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>exec</span><span class=p>(</span><span class=s1>&#39;curl http://www.foobar.com/wp-admin/upgrade.php?step=upgrade_db&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$deploy</span><span class=o>-&gt;</span><span class=na>log</span><span class=p>(</span><span class=s1>&#39;Updating wordpress database... &#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$deploy</span><span class=o>-&gt;</span><span class=na>execute</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>Most of the code is self-explanatory, but I&rsquo;ll go ahead and explain a few key pieces.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=nx>date_default_timezone_set</span><span class=p>(</span><span class=s1>&#39;America/Los_Angeles&#39;</span><span class=p>);</span>
</span></span></code></pre></div><p>If you set the <code>date.timezone</code> value in your <code>php.ini</code> file then you can safely remove this line, otherwise you should set it to your <a href=http://www.php.net/manual/en/timezones.php target=_blank rel="noopener noreffer">local timezone</a>.</p><pre tabindex=0><code>&lt;?php exec(&#39;git reset --hard HEAD&#39;, $output);
</code></pre><p>This tells git to remove any changes to files in the working-tree since the last <code>git pull</code>. If we don&rsquo;t do this and the working-tree is dirty then the deploy will fail.</p><pre tabindex=0><code>&lt;?php exec(&#39;git pull &#39;.$this-&gt;_remote.&#39; &#39;.$this-&gt;_branch, $output);
</code></pre><p>This just pulls in all new code from the remote and branch specified (defaults to <code>origin</code> remote and <code>master</code> branch).</p><pre tabindex=0><code>&lt;?php exec(&#39;chmod -R og-rx .git&#39;, $output);
</code></pre><p>Since the git repository is in the web root users could potentially view it&rsquo;s contents. This command modifies the permissions of all files in the <code>.git</code> directory so that only the file owner (you) can access them.</p><h2 id=configuring-the-script>Configuring the Script</h2><p>Most of the script defaults should work fine for the majority of users, but you will need to pass in the path to your web-root as the first parameter when creating the <code>Deploy</code> object. All of the other options can be configured by passing an array of values as the second parameter when creating the <code>Deploy</code> object.</p><p><strong>Option Defaults</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$options</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;log&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;deployments.log&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;date_format&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Y-m-d H:i:sP&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;branch&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;master&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;remote&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;origin&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></div><h2 id=post-deploy>Post Deploy</h2><p>If you need to do something after a deployment you can do so by adding a callback to the <code>Deploy</code> object before executing. By attaching the callback to the <code>Deploy</code> object you ensure the code only gets run if the deployment is successful.</p><p><strong>Example</strong></p><pre tabindex=0><code>&lt;?php

$deploy-&gt;post_deploy = function() use ($deploy) {
    // hit the wp-admin page to update any db changes
    exec(&#39;curl http://www.foobar.com/wp-admin/upgrade.php?step=upgrade_db&#39;);
    $deploy-&gt;log(&#39;Updating wordpress database... &#39;);
};
</code></pre><p>*Note: This example will only work on PHP 5.3+ because it <a href=http://php.net/manual/en/functions.anonymous.php target=_blank rel="noopener noreffer">uses a closure</a>. If your not on PHP 5.3 you will have to use a <a href=http://php.net/manual/en/language.pseudo-types.php target=_blank rel="noopener noreffer">traditional callback</a>.</p><h2 id=setting-up-the-service-hook>Setting Up the Service Hook</h2><p>Once you&rsquo;ve finished configuring your deploy script, go ahead and upload it to your servers web-root.</p><p>The next step is pretty straightforward, so I&rsquo;m just going to <a href=http://confluence.atlassian.com/display/BITBUCKET/Setting+Up+the+bitbucket+POST+Service target=_blank rel="noopener noreffer">point you directly to the documentation</a>.</p><p>Now test it out and enjoy your painless automated deployments!</p><h2 id=taking-it-a-step-further>Taking it a Step Further</h2><p>The script I&rsquo;ve written updates the server&rsquo;s repository regardless of whether or not the changes were made to the <code>master</code> branch (or whatever branch is your production branch). This works fine because it will only pull in changes from that branch anyway, but it would be nice if it would check what branch the changes are from and act accordingly.</p><p>Well, the good news is Bitbucket is <a href=http://confluence.atlassian.com/display/BITBUCKET/Setting+Up+the+bitbucket+POST+Service#SettingUpthebitbucketPOSTService-POSTData target=_blank rel="noopener noreffer">kind enough to send along a bunch of data</a> with the <code>POST</code> request which includes a list of all commits and their branch. It should be fairly easy to modify the script to check this data and only pull in changes if they are on your production branch.</p><h2 id=what-about-github>What About Github?</h2><p>Although I wrote the script for Bitbucket it should work with any git hosting providers as long as the have some sort of service hooks (which Github does, yay!).</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-08-25</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://brandonsummers.name/posts/2012/02/10/using-bitbucket-for-automated-deployments/ data-title="Using Bitbucket for Automated Deployments" data-via=bsummers82 data-hashtags=bitbucket,git,php><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://brandonsummers.name/posts/2012/02/10/using-bitbucket-for-automated-deployments/ data-hashtag=bitbucket><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://brandonsummers.name/posts/2012/02/10/using-bitbucket-for-automated-deployments/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://brandonsummers.name/posts/2012/02/10/using-bitbucket-for-automated-deployments/ data-title="Using Bitbucket for Automated Deployments"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://brandonsummers.name/posts/2012/02/10/using-bitbucket-for-automated-deployments/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/bitbucket/>bitbucket</a>,&nbsp;<a href=/tags/git/>git</a>,&nbsp;<a href=/tags/php/>php</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2012 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Brandon Summers</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://brandonsummers.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-328744705",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-328744705" async></script></body></html>